<!DOCTYPE html>

<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8" />
    <title>Anime Configuration</title>
</head>
<body>
    <div id="animeConfigurationPage" data-role="page" class="page type-interior pluginConfigurationPage">
        <div data-role="content">
            <div class="content-primary">

                <form id="animeConfigurationForm">
                    <ul class="ulForm" data-role="listview">
                        <li>
                            <label for="titleLanguage">Title Language:</label>
                            <select id="titleLanguage" name="titleLanguage">
                                <option id="optLanguageLocalized" value="Localized">Localized</option>
                                <option id="optLanguageRomaji" value="JapaneseRomaji">Romaji</option>
                                <option id="optLanguageJapanese" value="Japanese">Japanese</option>
                            </select>
                        </li>
                        <li>
                            <label for="chkAutomaticUpdates">
                                Allow Automatic Metadata Updates
                            </label>
                            <input id="chkAutomaticUpdates" name="chkAutomaticUpdates" type="checkbox" value="automaticUpdates" />
                        </li>
                        <li>
                            <label for="chkAutoCorrectSeriesPosters">
                                Automatically Correct Series Posters
                            </label>
                            <input id="chkAutoCorrectSeriesPosters" name="chkAutoCorrectSeriesPosters" type="checkbox" value="correctSeriesPosters" />
                        </li>
                        <li>
                            <label for="ignoreTree">Ignore the following locations:</label>
                            <div id="ignoreTree" class="ignoreTree" />
                        </li>
                        <li>
                            <button type="submit" data-theme="b">Save</button>
                            <button type="button" onclick=" history.back(); ">Cancel</button>
                        </li>
                    </ul>
                </form>
            </div>
        </div>
        
        <script type="text/javascript">
            var AnimeConfigurationPage =
            {
                pluginUniqueId: "1d0dddf7-1877-4473-8d7b-03f7dac1e559",
                
                virtualFolders: [],
                physicalFolders: [],

                loadConfiguration: function() {
                    Dashboard.showLoadingMsg();

                    ApiClient.getPluginConfiguration(AnimeConfigurationPage.pluginUniqueId).done(function(config) {
                        var page = $.mobile.activePage;

                        $('#titleLanguage', page).val(config.TitlePreference).change();
                        $('#chkAutomaticUpdates', page).checked(config.AllowAutomaticMetadataUpdates).checkboxradio("refresh");
                        $('#chkAutoCorrectSeriesPosters', page).checked(config.AutoCorrectSeriesPosters).checkboxradio("refresh");
                        
                        for (var i = 0; i < config.IgnoredVirtualFolders.length; i++) {
                            config.IgnoredVirtualFolders[i] = config.IgnoredVirtualFolders[i].replace(/\\\\/g, "\\");
                        }
                        for (var i = 0; i < config.IgnoredPhysicalLocations.length; i++) {
                            config.IgnoredPhysicalLocations[i] = config.IgnoredPhysicalLocations[i].replace(/\\\\/g, "\\");
                        }

                        AnimeConfigurationPage.loadCollectionIgnoreTree(page, config);

                        Dashboard.hideLoadingMsg();
                    });
                },

                saveConfiguration: function() {
                    Dashboard.showLoadingMsg();

                    var page = $.mobile.activePage;

                    ApiClient.getPluginConfiguration(AnimeConfigurationPage.pluginUniqueId).done(function(config) {

                        config.TitlePreference = $('#titleLanguage', page).val();
                        config.AllowAutomaticMetadataUpdates = $('#chkAutomaticUpdates', page).prop('checked');
                        config.AutoCorrectSeriesPosters = $('#chkAutoCorrectSeriesPosters', page).prop('checked');
                        
                        AnimeConfigurationPage.saveCollectionIgnoreTree(config);

                        ApiClient.updatePluginConfiguration(AnimeConfigurationPage.pluginUniqueId, config).done(function(result) {
                            Dashboard.processPluginConfigurationUpdateResult(result);
                        });
                    });
                },

                createVirtualFolderNode: function (virtualFolder, config) {
                    var id = AnimeConfigurationPage.virtualFolders.push(virtualFolder.Name) - 1;
                    
                    var node = {
                        attr: {
                            folderType: "virtual",
                            folderId: id
                        },
                        data: virtualFolder.Name,
                        state: "closed",
                        children: virtualFolder.Locations.map(function(location) {
                            return AnimeConfigurationPage.createFolderNode(location, config);
                        })
                    };
                    
                    if ($.inArray(virtualFolder.Name, config.IgnoredVirtualFolders) != -1) {
                        node.attr["class"] = "jstree-checked";
                    }

                    return node;
                },

                createFolderNode: function (folder, config) {
                    var id = AnimeConfigurationPage.physicalFolders.push(folder) - 1;

                    var node = {
                        attr: {
                            folderType: "physical",
                            folderId: id
                        },
                        data: folder
                    };

                    if ($.inArray(folder, config.IgnoredPhysicalLocations) != -1) {
                        node.attr["class"] = "jstree-checked";
                    }

                    return node;
                },
                
                loadCollectionIgnoreTree: function (page, config) {
                    ApiClient.getVirtualFolders().done(function (result) {
                        var virtualFolderNodes = result
                            .filter(function(virtualFolder) {
                                return virtualFolder.CollectionType == "tvshows";
                            })
                            .map(function(virtualFolder) {
                                return AnimeConfigurationPage.createVirtualFolderNode(virtualFolder, config);
                            });
                        
                        $('.ignoreTree').jstree({
                            "plugins": ["ui", "json_data", "checkbox", "themes"],

                            checkbox: {
                                real_checkboxes: true,
                                override_ui: true
                            },

                            data: virtualFolderNodes,

                            json_data: {
                                data: virtualFolderNodes
                            },

                            themes: {
                                theme: 'default',
                            }
                        });
                    });
                },
                
                saveCollectionIgnoreTree: function(config) {
                    var checked = $('.ignoreTree').jstree("get_checked");
                    
                    config.IgnoredVirtualFolders = checked
                        .filter(function() {
                            return $(this).attr("folderType") == "virtual";
                        })
                        .map(function() {
                            var id = $(this).attr("folderId");
                            return AnimeConfigurationPage.virtualFolders[id];
                        })
                        .toArray();
                    
                    config.IgnoredPhysicalLocations = checked
                        .filter(function () {
                            return $(this).attr("folderType") == "physical";
                        })
                        .map(function () {
                            var id = $(this).attr("folderId");
                            return AnimeConfigurationPage.physicalFolders[id];
                        })
                        .toArray();
                }
            };

            $('#animeConfigurationPage').on('pageshow', function () {
                AnimeConfigurationPage.loadConfiguration();
            });

            $('#animeConfigurationForm').on('submit', function () {
                AnimeConfigurationPage.saveConfiguration();
                return false;
            });
        </script>
    </div>
</body>
</html>